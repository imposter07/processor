<!doctype html>
<html lang="en" data-bs-theme="">
<head>
<link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

<style>
    .page-item, .btn-sm, .btn, .img-wrp, .navbar{
        opacity: .8;
    }

    .btn-primary {
        background-color: var(blue-100) !important;
    }

    body {
        padding-top: 65px;
        overflow-x: hidden;
        background-color: var(--bs-secondary-bg);
    }

    .navbar {
        background-color: var(--bs-secondary-bg);
    }

    .card-header, .card-body, .card-footer {
        padding: 20px;
    }

    html {
        scroll-behavior: smooth;
    }

    .shadow {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
        body {
            font-size: 0.9rem;
        }
    }

    .btn:hover {
        transform: translateY(-2px);
        transition: all 0.3s ease-in-out;
    }

    .card {
        margin-right: 20px !important;
        border-radius: .5rem !important;
    }

    .table {
        border-radius: 1rem !important;
    }

    .selectize-input {
        background-color: var(--bs-body-bg) !important;
    }

    .selectize-dropdown, .processor_popup {
        z-index: 10000 !important;
    }

    .custom-control-input {
      transform: scale(5);
    }

    .sidebar.collapse.show,
    .sidebar.collapse.show + .col {
        transition: .18s linear;
        left: 0;
    }

    .sidebar.collapse,
    .sidebar.collapsing,
    .sidebar.collapsing + .col {
        transition: .18s linear;
        z-index: 1050;
        left: -25%;
    }

    input[id^="apis-"]::placeholder {
        color: lightgrey;
    }

    .progress-bar, .bd-sidebar {
        transition: all 0.3s ease-in-out;
    }

    .form-control:read-only:not(select) {
        background-color: var(--bs-secondary-bg);
    }

</style>


<title>
    {% if title %}Liquid App | {{ title }}{% else %}
        {{ _('Welcome to the  Liquid App') }}{% endif %}
</title>
</head>
<div id="jinjaValues" data-index="{{ url_for('main.index', _external=True) }}"
    {% if title %}data-title="{{ title }}"{% endif %}
    {% if uploader_type %}data-uploader_type="{{ uploader_type }}"{% endif %}
    {% if object_name %}data-object_name="{{ object_name }}"{% endif %}
    {% if edit_name %}data-edit_name="{{ edit_name }}"{% endif %}
    {% if current_user %}data-username="{{ current_user.username }}"{% endif %}
    data-datatablesurl="{{ url_for('static', filename='Editor/dataTable.js') }}"
    data-datatableseditorurl="{{ url_for('static', filename='Editor/js/dataTables.editor.js') }}"
>
</div>
<nav id="navbar" class="navbar navbar-expand-lg fixed-top align-items-center" style="padding-top:1px;">
    <a class="navbar-brand" href="{{ url_for('main.index') }}">
        <img alt="Brand" class="img-responsive" style="height: 30px;"
             src={{ url_for('static', filename='logo-blk.png') }}>
    </a>
  <button class="navbar-toggler" type="button"
          data-bs-toggle="collapse" data-bs-target="#navbarToggler"
          aria-controls="navbarToggler" aria-expanded="false"
          aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
    <div class="collapse navbar-collapse" id="navbarToggler">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
              <a id="collapseSide" class="nav-link" data-bs-toggle="collapse"
                 href="#" data-bs-target=".collapse" role="button"
                 onclick="toggleNav()">
              <i class="bi bi-list btn" style="color:black"></i></a>
          <li class="nav-item"><a class="nav-link" title={{ _('Explore') }}
                  href="{{ url_for('main.explore') }}">
              <i class="bi bi-send-fill btn" href="#" style="color:black"></i></a>
          </li>
          <li class="nav-item"><a id="navLinkProcessor" class="nav-link" title={{ _('Processor') }}
                  href="{{ url_for('main.processor') }}">
              <i class="bi bi-bar-chart-fill btn" href="#" style="color:black"></i></a>
          </li>
      </ul>
        {% if g.search_form %}
            <form class="d-flex justify-content-center" method="get"
                  action="{{ url_for('main.chat') }}">
                {{ g.search_form.q(size=30, class='form-control', placeholder='Ask questions here....') }}
                <button class="btn btn-primary d-flex align-items-center"
                        href="{{ url_for('main.chat') }}">CHAT
                    <i class="bi bi-chat-fill ms-2"></i></button>
            </form>
        {% endif %}
        <ul class="navbar-nav ml-auto align-items-center">
            {% if current_user.is_anonymous %}
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('auth.login') }}">
                    {{ _('Login') }}</a>
            </li>
            {% else %}
                <li class="nav-item">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="darkSwitch" style="display:none;">
                        <label class="form-check-label" for="darkSwitch">
                            <span id="darkSwitchIcon" class="bi bi-sun-fill btn" style="color: black;"></span>
                        </label>
                    </div>
                </li>

                <li class="nav-item">
                    <a class="nav-link" title={{ _('Clients') }}
                            href="{{ url_for('main.clients') }}">
                    <i class="bi bi-calendar-fill btn" href="#" style="color:black"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" title={{ _('Messages') }}
                            href="{{ url_for('main.messages') }}">
                        <i class="bi bi-envelope-fill btn" href="#" style="color:black"></i>
                    {% set new_messages = current_user.new_messages() %}
                    <span id="message_count" class="badge text-dark" style="visibility: {% if new_messages %}visible
                          {% else %}hidden{% endif %};">
                        {{ new_messages }}
                    </span>
                </a>
                </li>
            <li class="nav-item">
                <a class="nav-link" title={{ _('Profile') }}
                        href="{{ url_for('main.user', username=current_user.username) }}">
                    <i class="bi bi-person-fill btn" href="#" style="color:black"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" title={{ _('Help') }}
                        href="{{ url_for('main.app_help') }}">
                    <i class="bi bi-question-circle-fill btn" href="#" style="color:black"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" title={{ _('Logout') }}
                        href="{{ url_for('auth.logout') }}">
                    <i class="bi bi-x-circle-fill btn" href="#" style="color:black"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </div>
</nav>

<div class="row vh-100 flex-nowrap" style="">
    <div class="bd-sidebar col-3 collapse show" style="overflow-y: auto;">
        {% block vertical_navbar %}{% endblock %}
    </div>
    <main class="col-9" role="main"
          style="overflow-y: visible; max-height: calc(100vh);">
        <div class="mb-4 bg-body-tertiary rounded-3 text-center shadow outer"
             style="padding-top: 5px; padding-bottom: 5px;">
            <div class="container-fluid">
                {% if current_user.is_authenticated %}
                {% with tasks = current_user.get_tasks_in_progress() %}
                {% if tasks %}
                    {% for task in tasks %}
                        <div aria-live="polite" aria-atomic="true"
                             style="position: relative; min-height: 1px;">
                            <div role="alert" aria-live="assertive" aria-atomic="true" class="toast" data-bs-autohide="false">
                                <div class="toast-header">
                                    <strong class="mr-auto">Task
                                        Complete!</strong>
                                    <small> <span
                                            id="toast-small"></span></small>
                                    <button type="button"
                                            class="ml-2 mb-1 close"
                                            data-bs-dismiss="toast"
                                            aria-label="Close"
                                            onclick="destroyToast()">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div id="toast-body" class="toast-body">
                                    {{ task.description }}
                                </div>
                            </div>
                        </div>
                    <div class="alert alert-success" role="alert">
                        {{ task.description }}
                        <span id="{{ task.id }}-progress">{{ task.get_progress() }}</span>%
                    </div>
                    {% endfor %}
                {% endif %}
                {% endwith %}
                {% endif %}
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                        <div class="alert alert-info" role="alert">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                <div id="alertContainer">
                    <div id="alertPlaceholder"></div>
                </div>
                {# application content needs to be provided in the app_content block #}
                {% block app_header %}{% endblock %}
            </div>
        </div>
        <div class="">
            {% block app_content %}{% endblock %}
            {% block app_content_2 %}{% endblock %}
            {% block app_content_3 %}{% endblock %}
        </div>
    </main>
</div>

{{ moment.include_moment() }}
{{ moment.lang(g.locale) }}

<script defer type="text/javascript"
        src="{{ url_for('static', filename='bootstrap-dark/darkModeHelper.js') }}"></script>
<script defer
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous">
</script>

<script>

    async function translate(sourceElem, destElem, sourceLang, destLang) {
        document.getElementById(destElem).innerHTML =
            '<img src="{{ url_for('static', filename='loading.gif') }}">';
        const response = await fetch('/translate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json; charset=utf-8'},
            body: JSON.stringify({
                text: document.getElementById(sourceElem).innerText,
                source_language: sourceLang,
                dest_language: destLang
            })
        })
        const data = await response.json();
        document.getElementById(destElem).innerText = data.text;
    }

    function initializePopovers(modelName = 'user') {
        const popups = document.getElementsByClassName(`${modelName}_popup`);
        for (let i = 0; i < popups.length; i++) {
            const popover = new bootstrap.Popover(popups[i], {
                content: 'Loading...',
                animation: true,
                trigger: 'hover focus',
                placement: 'auto',
                html: true,
                sanitize: false,
                delay: {show: 500, hide: 250},
                container: 'body',
                customClass: 'd-inline',
            });
            popups[i].addEventListener('show.bs.popover', async (ev) => {
                if (ev.target.popupLoaded) {
                    return;
                }
                const response = await fetch(`/${modelName}/${ev.target.innerText.trim()}/popup`);
                const data = await response.text();
                const popover = bootstrap.Popover.getInstance(ev.target);
                if (popover && data) {
                    ev.target.popupLoaded = true;
                    popover.setContent({'.popover-body': data});
                    flask_moment_render_all();
                }
            });
        }
        const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="hover"]');
        const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
    }

    function processorPopovers() {
        initializePopovers('processor');
    }

    document.addEventListener('DOMContentLoaded', initializePopovers);
    document.addEventListener('DOMContentLoaded', processorPopovers);

    function set_message_count(n) {
        const count = document.getElementById('message_count');
        count.innerText = n;
        count.style.visibility = n ? 'visible' : 'hidden';
    }

    function set_task_progress(task_id, progress) {
        const progressElement = document.getElementById(task_id + '-progress');
        if (progressElement) {
            progressElement.innerText = progress;
        }
    }

    {% if current_user.is_authenticated %}
        function initialize_notifications() {
            let since = 0;
            setInterval(async function () {
                const response = await fetch('{{ url_for('main.notifications') }}?since=' + since);
                const notifications = await response.json();
                for (let i = 0; i < notifications.length; i++) {
                    switch (notifications[i].name) {
                        case 'unread_message_count':
                            set_message_count(notifications[i].data);
                            break;
                        case 'task_progress':
                            set_task_progress(notifications[i].data.task_id,
                                notifications[i].data.progress);
                            break;
                    }
                    since = notifications[i].timestamp;
                }
            }, 10000);
        }

        function createPlan(processorId) {
            let data = {
                processor_id: processorId,
            }
            let formData = convertDictToFormData(data);
            fetch('/create_plan_from_processor', {
              method: 'POST',
              body: formData,
            }).then(response => response.json()).then((data) => {
                window.location.href = data['url'];
            }).catch(error => {
                console.log("Request failed: " + error);
                displayAlert('An unexpected error occurred.', 'warning');
                window.location.reload(true)
            });
        }

        function addCreatePlanEvent() {
            loadingBtn(this);
            let processorId = this.id.replace('createPlan', '');
            createPlan(processorId);
        }

        document.addEventListener('DOMContentLoaded', initialize_notifications);

    {% endif %}
</script>
</html>