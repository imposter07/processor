{% extends "base.html" %}
{% block app_header %}
<style>
.chat-container {
  position: relative;
  height: calc(100vh - 100px);
  overflow-y: auto;
}

.chat-input {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 60px;
  background-color: #f2f2f2;
  padding: 10px;
}

/* Optional: Add margin to the bottom of the chat messages container to make room for the chat input */
.chat-container {
  margin-bottom: 70px;
}

.messages {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  overflow-wrap: break-word;
}

.message {
  border-radius: 20px;
  padding: 8px 15px;
  margin-top: 5px;
  margin-bottom: 5px;
  display: inline-block;
}

.yours {
  align-items: flex-start;
}

.yours .message {
  margin-right: 25%;
  background-color: #eee;
  position: relative;
}

.yours .message.last:before {
  content: "";
  position: absolute;
  z-index: 0;
  bottom: 0;
  left: -7px;
  height: 20px;
  width: 20px;
  background: #eee;
  border-bottom-right-radius: 15px;
}
.yours .message.last:after {
  content: "";
  position: absolute;
  z-index: 1;
  bottom: 0;
  left: -10px;
  width: 10px;
  height: 20px;
  background: white;
  border-bottom-right-radius: 10px;
}

.mine {
  align-items: flex-end;
}

.mine .message {
  color: white;
  margin-left: 25%;
  background: linear-gradient(to bottom, #00D0EA 0%, #0085D1 100%);
  background-attachment: fixed;
  position: relative;
}

.mine .message.last:before {
  content: "";
  position: absolute;
  z-index: 0;
  bottom: 0;
  right: -8px;
  height: 20px;
  width: 20px;
  background: linear-gradient(to bottom, #00D0EA 0%, #0085D1 100%);
  background-attachment: fixed;
  border-bottom-left-radius: 15px;
}

.mine .message.last:after {
  content: "";
  position: absolute;
  z-index: 1;
  bottom: 0;
  right: -10px;
  width: 10px;
  height: 20px;
  background: white;
  border-bottom-left-radius: 10px;
}
</style>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<h2 class="">{{ _('{}'.format(title)) }}</h2>
{% endblock %}
{% block app_content %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col">
                <div class="card">
                    <div class="card-header">ALI</div>
                    <div id="chatContainer" class="card-body chat-container">
                    </div>
                    <div class="card-footer chat-input">
                        <div id="chatInputGroup" class="input-group">
                            <input id="chatInput" type="text"
                                   class="form-control"
                                   placeholder="Type your message">
                            <div class="input-group-append">
                                <button id="chatInputBtn"
                                        class="btn btn-outline-primary"
                                        type="button">Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script src="{{ url_for('static', filename='js_utils.js') }}"></script>
    <script>
        function createMessageHtml(message, owner='mine') {
            let d = new Date();
            let timeSaid = d.getHours() + ':' + d.getMinutes();
            let speaker = (owner === 'mine') ? document.getElementById('jinjaValues').dataset['username'] : 'ALI';
            return `
                <div class="${owner} messages">
                    <div class="message last">
                        <p class="meta">${speaker} - <span>${timeSaid}</span></p>
                        <p class="text">${message}</p>
                    </div>
                </div>`
        }
        function addMessageToChat(message, owner='mine') {

            let chatContainer = document.getElementById('chatContainer');
            chatContainer.insertAdjacentHTML('beforeend', createMessageHtml(message, owner));
        }

        function postChatResponse (data, kwargs) {
            let response = data['data'];
            let message = document.getElementById('chatInput');
            message.value = '';
            let clickElem = kwargs['clickElem'];
            addElemRemoveLoadingBtn(clickElem.id);
            addMessageToChat(response, 'yours');

        }

        function postChat() {
            let chatInputGroup = document.getElementById('chatInputGroup');
            loadingBtn(chatInputGroup);
            let message = document.getElementById('chatInput').value;
            addMessageToChat(message, 'mine');
            let data = {
                'message': message
            }
            let kwargs = {
                'clickElem': chatInputGroup
            }
            makeRequest('/post_chat', 'POST', data, postChatResponse, 'json', kwargs);
        }

        document.addEventListener("DOMContentLoaded", function() {
            let introMsg = 'Hello I am ALI (Artificial Liquid Interface) what can I help you with today?';
            addMessageToChat(introMsg, 'yours');
            addOnClickEvent('#chatInputBtn', postChat);
            // addOnClickEvent('#chatInput', postChat, 'keyup')
        });
    </script>
{% endblock %}