{% extends "create_processor.html" %}

{% block app_content %}
    <style type="text/css">
        .widget {
            height: 25vh;
            width: 175px;
            margin-left: auto;
            margin-right: auto;
        }

        .overlay {
            fill: none;
            pointer-events: all;
        }

        .radial-progress-bar {
            fill: #ddd;
            margin-left: auto;
            margin-right: auto;
            margin-top: auto;
        }

        .radial-progress-bar-bg {
            fill: #3f3f3f;
        }

        .progress-label {
            fill: #aaa;
            font-family: 'Open Sans', sans-serif;
            font-size: 15px;
            text-anchor: middle;
            dominant-baseline: central;
        }

        .outer {
            overflow: auto;
        }

        .icon-badge-container {
          position: relative;
        }

        .icon-badge {
          display: inline-block;
          background-color: red;
          font-size: 12px;
          color: white;
          text-align: center;
          position: absolute;
          width: 35%;
          border-radius: 35%;
          top: -10%;
          left: 70%;
        }
    </style>
    <nav>
    <div class="row">
        <div class="col-md-12">
            <div class="card-header">
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <a class="nav-link active" id="nav-dash-tab"
                       data-toggle="tab" href="#nav-dash" role="tab"
                       aria-controls="nav-dash" aria-selected="true">
                        <h4>
                            <i class="fas fa-solid fa-chart-column btn btn-secondary"
                               style="float:right;" aria-hidden="true"></i></h4>
                    </a>
                    <a class="nav-link" id="nav-pacing-tab" data-toggle="tab" href="#nav-pacing" role="tab" aria-controls="nav-pacing" aria-selected="false"
                        onclick="setTimeout(getMetrics, 1000, '#pacingAlerts', generateAlerts, ['vendorname', 'campaignname'], ['netcost', 'adservingcost']);
                                 setTimeout(getPacingTable, 1000, 'Pacing Table');
                                 this.onclick=null;">
                        <h4>
                            <div class="icon-badge-container">
                            <i class="fas fa-solid fa-table-cells btn btn-secondary" style="float:right;" aria-hidden="true"></i>
                            <div class="icon-badge" id="pacingAlertCount"></div>
                            </div>
                            <div id="pacingAlertCountProgress" style="height:50px; width:100px;" hidden></div>
                        </h4>
                    </a>
                    <a class="nav-link" id="nav-billing-tab"
                       data-toggle="tab" href="#nav-billing" role="tab"
                       aria-controls="nav-billing" aria-selected="true">
                        <h4>
                            <i class="fas fa-solid fa-money-bill btn btn-secondary"
                               style="float:right;" aria-hidden="true"></i></h4>
                    </a>
                </div>
            </div>
        </div>
    </div>
    </nav>
    <div class="tab-content" id="nav-dash-tabContent">
        <div class="tab-pane fade show active" id="nav-dash"
             role="tabpanel" aria-labelledby="nav-dash-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card-header">
                        <div class="row" id="navRow">
                            <div class="btn-group btn-group-sm btn-block" role="group">
                                <button id="getAllCharts"
                                        class="btn btn-outline-primary"><i
                                        class="fas fa-chart-bar" href="#" role="button"
                                        aria-hidden="true"></i>Get All Charts
                                </button>
                            </div>
                        </div>
                        <div class="row" id="filterRow" hidden="">
                            <div class="col mb-3">
                                <select id="campaignnameSelect" multiple=""
                                        class="form-control form-control-sm">
                                    <option value="">Campaign</option>
                                </select>
                            </div>
                            <div class="col mb-3">
                                <select id="vendornameSelect" multiple=""
                                        class="form-control form-control-sm">
                                    <option value="">Vendor</option>
                                </select>
                            </div>
                            <div class="col mb-3">
                                <select id="countrynameSelect" multiple=""
                                        class="form-control form-control-sm">
                                    <option value="">Country</option>
                                </select>
                            </div>
                            <div class="col mb-3">
                                <select id="environmentnameSelect" multiple=""
                                        class="form-control form-control-sm">
                                    <option value="">Environment</option>
                                </select>
                            </div>
                            <div class="col mb-3">
                                <select id="kpinameSelect" multiple=""
                                        class="form-control form-control-sm">
                                    <option value="">KPI</option>
                                </select>
                            </div>
                            <div class="col mb-3">
                                <div class="row">
                                    <input id="datePicker"
                                           class="custom-select custom-select-sm
                                                  flatpickr flatpickr-input active"
                                           type="text" placeholder="Date"
                                           data-id="range"
                                           readonly="readonly" data-input>
                                </div>
                            </div>
                            <div class="col mb-3">
                                <button id="applyFilter" type="button"
                                        class="btn btn-block btn-outline-primary btn-sm">
                                    Apply Filter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <br>
            <div class="row">
                <div class="col-md-12 h-50">
                    <div class="card-deck container-fluid text-center">
                        <div id="totalMetricsProgress" class='widget'></div>
                        <div id="totalMetrics" class="row w-100"></div>
                    </div>
                </div>
            </div>

            <br>
            <div class="row">
                <div class="col-md-3 h-50">
                    <div class="card-header">
                        <h7 class="mb-3">Delivery</h7>
                        <select id="deliveryMetricsSelect"
                                class="form-control form-control-sm">
                            <option>Select Campaign</option>
                        </select>
                    </div>
                    <div class="card container-fluid shadow outer">
                        <div id="deliveryMetricsProgress" class='widget'></div>
                        <div id="deliveryMetrics" style="height:250px;"></div>
                    </div>
                </div>
                <div class="col-md-9 h-50">
                    <div class="card-header">
                        <h7 class="mb-3">Daily</h7>
                        <select id="dailyMetricsSelect" class="form-control form-control-sm">
                            <option>Select Metric</option>
                        </select>
                    </div>
                    <div class="card container-fluid shadow outer">
                        <div id="dailyMetricsProgress" class='widget'></div>
                        <div id="dailyMetrics"></div>
                    </div>
                </div>
            </div>
            <br>
            <div class="row" id="thirdRow" hidden="">
                <div class="col-md-6 h-50">
                    <div class="card-header">
                        <h7 class="mb-3">Partner</h7>
                        <select id="partnerMetricsSelect"
                                class="form-control form-control-sm">
                            <option>Select Metric</option>
                        </select>
                    </div>
                    <div class="card container-fluid shadow outer">
                        <div id="partnerMetricsProgress" class='widget'></div>
                        <div id="partnerMetrics"></div>
                    </div>
                </div>
                <div class="col-md-6 h-50">
                    <div class="card-header">
                        <h7 class="mb-3">Country</h7>
                        <select id="countryMetricsSelect"
                                class="form-control form-control-sm">
                            <option>Select Metric</option>
                        </select>
                    </div>
                    <div class="card container-fluid shadow outer">
                        <div id="countryMetricsProgress" class='widget'></div>
                        <div id="countryMetrics"></div>
                    </div>
                </div>
            </div><br>
            <div class="row" id="fourthRow" hidden="">
                <div class="col-md-4 h-50">
                    <div class="card-header">
                        <h7 class="mb-3">Campaign</h7>
                        <select id="campaignMetricsSelect"
                                class="form-control form-control-sm">
                            <option>Select Metric</option>
                        </select>
                    </div>
                    <div class="card container-fluid shadow outer">
                        <div id="campaignMetricsProgress" class='widget'></div>
                        <div id="campaignMetrics"></div>
                    </div>
                </div>
                <div class="col-md-4 h-50">
                    <div class="card-header">
                        <h7 class="mb-3">Device</h7>
                        <select id="environmentMetricsSelect"
                                class="form-control form-control-sm">
                            <option>Select Metric</option>
                        </select>
                    </div>
                    <div class="card container-fluid shadow outer">
                        <div id="environmentMetricsProgress" class='widget'></div>
                        <div id="environmentMetrics"></div>
                    </div>
                </div>
                <div class="col-md-4 h-50">
                    <div class="card-header">
                        <h7 class="mb-3">KPI</h7>
                        <select id="kpiMetricsSelect"
                                class="form-control form-control-sm">
                            <option>Select Metric</option>
                        </select>
                    </div>
                    <div class="card container-fluid shadow outer">
                        <div id="kpiMetricsProgress" class='widget'></div>
                        <div id="kpiMetrics"></div>
                    </div>
                </div>
            </div>
        </div>
        {% include 'pacing.html' %}
        <div class="tab-pane fade show" id="nav-billing" role="tabpanel"
             aria-labelledby="nav-dash-tab"></div>
            <div class="row">
                <div id="billingTable"></div>
            </div>
    </div>

    <script>
        function getAllCharts(filterDict, clickElem = null, oldHtml = null,
                              allCharts = false) {
            let metrics = ['kpi'];
            getMetrics('#totalMetrics', generateTotalCards, ['mpProduct Name'],
                metrics, filterDict, "row w-100", 125, clickElem, oldHtml);
            getMetrics('#dailyMetrics', generateAreaChart, ['eventdate'],
                metrics, filterDict);
            getMetrics('#deliveryMetrics', generateProgressBars, ['vendorname'],
                ['netcost', 'plannednetcost'], filterDict);
            getMetrics('#pacingAlertCount', generateAlertCount, ['vendorname'],
                ['netcost', 'plannednetcost'], filterDict);
            if (allCharts) {
                getSecondaryCharts(filterDict, clickElem);
            }
        }

        function getSecondaryCharts(filterDict, clickElem=null) {
            let addSelect = !(clickElem);
            let metrics = ['kpi'];
            let rowIds = ['thirdRow', 'fourthRow', 'filterRow'];
            rowIds.forEach(elemId => {
                document.getElementById(elemId).removeAttribute('hidden');
            });
            let cols = ['partner', 'country', 'campaign', 'environment', 'kpi'];
            cols.forEach(function (col, i) {
                let chartId = `#${col}Metrics`;
                let colName = (col === 'partner') ? 'vendorname' : `${col}name`;
                let chartType = (i > 1) ? generateLollipopChart : generateBarChart;
                getMetrics(chartId, chartType, [colName],
                    metrics, filterDict, null, null, null, null, addSelect);
            })
        }

        function getDates() {
            const fp = document.querySelector('#datePicker')._flatpickr;
            return [{eventdate: fp.selectedDates}]
        }

        function getFilters(colName, filterDict) {
            let newFilter = {};
            newFilter[colName] = $('#' + colName + 'Select')[0].selectize.items;
            filterDict = filterDict.concat(newFilter);
            return filterDict
        }

        function getAllFilters() {
            let filterDict = getDates();
            let cols = ['campaignname', 'vendorname', 'countryname',
                'environmentname', 'kpiname'];
            cols.forEach(col => {
                filterDict = getFilters(col, filterDict);
            })
            return filterDict
        }

        function applyFilterEvent() {
            loadingBtn(this);
            animateBar();
            let filterDict = getAllFilters();
            getAllCharts(filterDict, this.id, 'None', true);
            addElemRemoveLoadingBtn(this.id);
        }

        function getAllChartsClickEvent() {
            loadingBtn(this);
            animateBar();
            let filterDict = getAllFilters();
            getSecondaryCharts(filterDict);
            addElemRemoveLoadingBtn(this.id);
            this.setAttribute('hidden', true);
        }

        function getBillingTable() {
            let billingTableId = 'billingTable';
            getTable(billingTableId, billingTableId);
        }

        document.addEventListener("DOMContentLoaded", function() {
            addOnClickEvent('button[id^="getAllCharts"]', getAllChartsClickEvent);
            addOnClickEvent('button[id^="applyFilter"]', applyFilterEvent);
            addOnClickEvent('[id^="nav-billing-tab"]', getBillingTable);
            addSelectize();
            $("#datePicker").flatpickr({
                mode: "range"
            });
            getAllCharts();
        });
    </script>
{% endblock %}