{% extends "create_processor.html" %}

{% block app_content %}
    <style type="text/css">
        .widget {
            height: 25vh;
            width: 175px;
            margin-left: auto;
            margin-right: auto;
        }

        .overlay {
            fill: none;
            pointer-events: all;
        }

        .progress-bar {
            fill: #ddd;
            margin-left: auto;
            margin-right: auto;
            margin-top: auto;
        }

        .progress-bar-bg {
            fill: #3f3f3f;
        }

        .progress-label {
            fill: #aaa;
            font-family: 'Open Sans', sans-serif;
            font-size: 15px;
            text-anchor: middle;
            dominant-baseline: central;
        }

        .outer {
            overflow: auto;
        }
    </style>
    <div class="row">
        <div class="col-md-12">
            <div class="card-header">
                <div class="row" id="navRow">
                    <div class="btn-group btn-group-sm btn-block" role="group">
                        <button id="getAllCharts"
                                class="btn btn-outline-primary"><i
                                class="fas fa-chart-bar" href="#" role="button"
                                aria-hidden="true"></i>Get All Charts
                        </button>
                    </div>
                </div>
                <div class="row" id="filterRow" hidden="">
                    <div class="col mb-3">
                        <select id="campaignnameSelect" multiple=""
                                class="form-control form-control-sm">
                            <option value="">Campaign</option>
                        </select>
                    </div>
                    <div class="col mb-3">
                        <select id="vendornameSelect" multiple=""
                                class="form-control form-control-sm">
                            <option value="">Vendor</option>
                        </select>
                    </div>
                    <div class="col mb-3">
                        <select id="countrynameSelect" multiple=""
                                class="form-control form-control-sm">
                            <option value="">Country</option>
                        </select>
                    </div>
                    <div class="col mb-3">
                        <select id="environmentnameSelect" multiple=""
                                class="form-control form-control-sm">
                            <option value="">Environment</option>
                        </select>
                    </div>
                    <div class="col mb-3">
                        <select id="kpinameSelect" multiple=""
                                class="form-control form-control-sm">
                            <option value="">KPI</option>
                        </select>
                    </div>
                    <div class="col mb-3">
                        <div class="row">
                            <input id="datePicker"
                                   class="custom-select custom-select-sm
                                          flatpickr flatpickr-input active"
                                   type="text" placeholder="Date"
                                   data-id="range"
                                   readonly="readonly" data-input>
                        </div>
                    </div>
                    <div class="col mb-3">
                        <button id="applyFilter" type="button"
                                class="btn btn-block btn-outline-primary btn-sm">
                            Apply Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <br>
    <div class="row">
        <div class="col-md-12 h-50">
            <div class="card-deck container-fluid text-center">
                <div id="totalMetricsProgress" class='widget'></div>
                <div id="totalMetrics" class="row w-100"></div>
            </div>
        </div>
    </div>

    <br>
    <div class="row">
        <div class="col-md-3 h-50">
            <div class="card-header">
                <h7 class="mb-3">Delivery</h7>
                <select id="deliveryMetricsSelect"
                        class="form-control form-control-sm">
                    <option>Select Campaign</option>
                </select>
            </div>
            <div class="card container-fluid shadow outer">
                <div id="deliveryMetricsProgress" class='widget'></div>
                <div id="deliveryMetrics" style="height:250px;"></div>
            </div>
        </div>
        <div class="col-md-9 h-50">
            <div class="card-header">
                <h7 class="mb-3">Daily</h7>
                <select id="dailyMetricsSelect" class="form-control form-control-sm">
                    <option>Select Metric</option>
                </select>
            </div>
            <div class="card container-fluid shadow outer">
                <div id="dailyMetricsProgress" class='widget'></div>
                <div id="dailyMetrics"></div>
            </div>
        </div>
    </div>
    <br>
    <div class="row" id="thirdRow" hidden="">
        <div class="col-md-6 h-50">
            <div class="card-header">
                <h7 class="mb-3">Partner</h7>
                <select id="partnerMetricsSelect"
                        class="form-control form-control-sm">
                    <option>Select Metric</option>
                </select>
            </div>
            <div class="card container-fluid shadow outer">
                <div id="partnerMetricsProgress" class='widget'></div>
                <div id="partnerMetrics"></div>
            </div>
        </div>
        <div class="col-md-6 h-50">
            <div class="card-header">
                <h7 class="mb-3">Country</h7>
                <select id="countryMetricsSelect"
                        class="form-control form-control-sm">
                    <option>Select Metric</option>
                </select>
            </div>
            <div class="card container-fluid shadow outer">
                <div id="countryMetricsProgress" class='widget'></div>
                <div id="countryMetrics"></div>
            </div>
        </div>
    </div><br>
    <div class="row" id="fourthRow" hidden="">
        <div class="col-md-4 h-50">
            <div class="card-header">
                <h7 class="mb-3">Campaign</h7>
                <select id="campaignMetricsSelect"
                        class="form-control form-control-sm">
                    <option>Select Metric</option>
                </select>
            </div>
            <div class="card container-fluid shadow outer">
                <div id="campaignMetricsProgress" class='widget'></div>
                <div id="campaignMetrics"></div>
            </div>
        </div>
        <div class="col-md-4 h-50">
            <div class="card-header">
                <h7 class="mb-3">Device</h7>
                <select id="environmentMetricsSelect"
                        class="form-control form-control-sm">
                    <option>Select Metric</option>
                </select>
            </div>
            <div class="card container-fluid shadow outer">
                <div id="environmentMetricsProgress" class='widget'></div>
                <div id="environmentMetrics"></div>
            </div>
        </div>
        <div class="col-md-4 h-50">
            <div class="card-header">
                <h7 class="mb-3">KPI</h7>
                <select id="kpiMetricsSelect"
                        class="form-control form-control-sm">
                    <option>Select Metric</option>
                </select>
            </div>
            <div class="card container-fluid shadow outer">
                <div id="kpiMetricsProgress" class='widget'></div>
                <div id="kpiMetrics"></div>
            </div>
        </div>
    </div>

    <script>
        function getAllCharts(filterDict, clickElem=null, oldHtml=null,
                              allCharts=false) {
            let metrics = ['kpi']
            getMetrics('#totalMetrics', generateTotalCards, 'mpProduct Name',
                 metrics, filterDict, "row w-100", 125, clickElem, oldHtml);
            getMetrics('#dailyMetrics', generateAreaChart, 'eventdate',
                metrics, filterDict);
            getMetrics('#deliveryMetrics', generateProgressBars, 'vendorname',
                ['netcost', 'plannednetcost'], filterDict);
            if (allCharts) {
                getSecondaryCharts(filterDict, clickElem)
            }
        }

        function getSecondaryCharts(filterDict, clickElem=null) {
            let addSelect = !(clickElem)
            let metrics = ['kpi']
            $('#thirdRow').removeAttr('hidden')
            $('#fourthRow').removeAttr('hidden')
            $('#filterRow').removeAttr('hidden')
            getMetrics('#partnerMetrics', generateBarChart, 'vendorname',
                metrics, filterDict, null, null, null, null, addSelect);
            getMetrics('#countryMetrics', generateBarChart, 'countryname',
                metrics, filterDict, null, null, null, null, addSelect);
            getMetrics('#campaignMetrics', generateLollipopChart, 'campaignname',
                metrics, filterDict, null, null, null, null, addSelect);
            getMetrics('#environmentMetrics', generateLollipopChart, 'environmentname',
                metrics, filterDict, null, null, null, null, addSelect)
            getMetrics('#kpiMetrics', generateLollipopChart, 'kpiname',
                metrics, filterDict, null, null, null, null, addSelect)
        }

        function getDates() {
            const fp = document.querySelector('#datePicker')._flatpickr;
            return [{eventdate: fp.selectedDates}]
        }

        function getFilters(colName, filterDict) {
            let newFilter = {};
            newFilter[colName] = $('#' + colName + 'Select')[0].selectize.items
            filterDict = filterDict.concat(newFilter)
            return filterDict
        }

        $(document).ready(function() {
            $('button[id^="applyFilter"]').unbind('click').click(function () {
                let dropdownButton = "#" + $(this)[0].id;
                $(dropdownButton).prop("disabled", true);
                let oldHtml = $(dropdownButton).html();
                $(dropdownButton).html(
                    `<span class="spinner-grow spinner-grow-sm" role="status"
                      aria-hidden="true"></span> Loading...`
                  );
                animateBar();
                let filterDict = getDates();
                filterDict = getFilters('campaignname', filterDict);
                filterDict = getFilters('vendorname', filterDict);
                filterDict = getFilters('countryname', filterDict);
                filterDict = getFilters('environmentname', filterDict);
                filterDict = getFilters('kpiname', filterDict);
                console.log(filterDict)
                getAllCharts(filterDict, dropdownButton, oldHtml, true);
            });
        });

        $(document).ready(function() {
            $('button[id^="getAllCharts"]').unbind('click').click(function () {
                let dropdownButton = "#" + $(this)[0].id;
                $(dropdownButton).prop("disabled", true);
                $(dropdownButton).html(
                    `<span class="spinner-grow spinner-grow-sm" role="status"
                      aria-hidden="true"></span> Loading...`
                  );
                animateBar();
                let filterDict = getDates();
                filterDict = getFilters('campaignname', filterDict);
                filterDict = getFilters('vendorname', filterDict);
                filterDict = getFilters('countryname', filterDict);
                filterDict = getFilters('environmentname', filterDict);
                filterDict = getFilters('kpiname', filterDict);
                getSecondaryCharts(filterDict, dropdownButton);
                $(dropdownButton).attr("hidden",true);
            });
        });

        function addSelectOptions(data, xCol) {
            let i = 0;
            let newData = $.map(data, function (obj) {
                obj['text'] = obj['text'] || obj[xCol];
                obj['id'] = obj['text'] || obj[xCol];
                obj['value'] = obj['text'] || obj[xCol];
                i++;
                return obj;
            });
            let elem = selectDiv ? selectDiv : "#" + xCol + "Select"
            let selectizeElem = $(elem)[0].selectize
            selectizeElem.load(function (callback) {
                callback(newData);
            });
        }

        $(document).ready(function () {
            $("select[id$='MetricsSelect']").selectize();
            $("#datePicker").flatpickr({
                mode: "range"
            });
            console.log('getting the charts')
            getAllCharts()
        });
    </script>
{% endblock %}