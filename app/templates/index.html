{% extends "base.html" %}

{% block app_header %}
    <h1>{{ _('Hi, %(username)s!', username=current_user.username) }}</h1>
{% endblock %}

{% block vertical_navbar %}
    <h4 class="sidebar-heading d-flex justify-content-between align-items-center
               text-center">
                  <span>{{ _('Latest Posts') }}</span>
    </h4>
    {% if form %}
        {% include '_form.html' %}
    <br>
    {% endif %}
    {% if not posts %}
        <h4 class="sidebar-heading d-flex justify-content-between align-items-center
           text-center">
              <span>{{ _('No posts.  Follow something.') }}</span>
        </h4>
        <h4 class="sidebar-heading d-flex justify-content-between align-items-center
           text-center">
              <a href="{{ url_for('main.clients') }}">{{ _('View clients') }}</a>
              <a href="{{ url_for('main.processor') }}">{{ _('View processors') }}</a>
        </h4>
    {% endif %}
    {% for post in posts %}
        {% include '_post.html' %}
    {% endfor %}
    <nav aria-label="...">
        <ul class="pagination justify-content-center">
            <li class="page-item{% if not prev_url %} page-item disabled{% endif %}">
                <a class="page-link"  href="{{ prev_url or '#' }}">
                    <span aria-hidden="true">&larr;</span> {{ _('Newer posts') }}
                </a>
            </li>
            <li class="page-item{% if not next_url %} page-item disabled{% endif %}">
                <a class="page-link"  href="{{ next_url or '#' }}">
                    {{ _('Older posts') }} <span aria-hidden="true">&rarr;</span>
                </a>
            </li>
        </ul>
    </nav>
{% endblock %}

{% block app_content %}
<nav aria-label="Page navigation example">
  <ul id="processorsPage" class="pagination justify-content-center">
  </ul>
</nav>

<div id="processors" class="card-deck"></div>

<div id="carousel" class="carousel slide" data-ride="carousel">
    <div class="carousel-inner text-center">
    <div class="carousel-item active">
        <a class="entry-thumb" title={{ _('Processor') }}
                href="{{ url_for('main.processor') }}" rel="noopener"
           target="_blank">
            <div class="position-relative overflow-hidden
                        p-3 p-md-5 m-md-3 text-center">
                <h1 class="display-4 font-weight-normal ">
                    {{ _('Processor') }}</h1>
                <p class="lead font-weight-normal">
                    {{ _('Create, view and update live campaigns using the data processor.') }}</p>
                <a class="fas fa-chart-bar btn-secondary btn-lg m-md-3"
                   title={{ _('Processor') }} href="{{ url_for('main.processor') }}"></a>
                <p>
                    <img src="{{ url_for('static', filename='data.jpg') }}"
                     style="height: 400px;">
                </p>
            </div>
        </a>
    </div>
    <div class="carousel-item">
        <a class="entry-thumb" title={{ _('Uploader') }}
                href="{{ url_for('main.uploader') }}" rel="noopener"
           target="_blank">
            <div class="position-relative overflow-hidden
                        p-3 p-md-5 m-md-3 text-center">
                <h1 class="display-4 font-weight-normal ">
                    {{ _('Uploader') }}</h1>
                <p class="lead font-weight-normal">
                    {{ _('Create and upload new campaigns to Facebook, AdWords and DCM.') }}</p>
                <a class="fas fa-chart-bar btn-secondary btn-lg m-md-3"
                   title={{ _('Uploader') }} href="#"></a>
                <p>
                    <img src="{{ url_for('static', filename='fb.jpg') }}"
                      style="height: 400px;">
                </p>
            </div>
        </a>
    </div>
    <div class="carousel-item">
        <a class="entry-thumb" title={{ _('Clients') }}
                href="{{ url_for('main.clients') }}" rel="noopener" target="_blank">
            <div class="position-relative overflow-hidden p-3 p-md-5 m-md-3 text-center">
                <h1 class="display-4 font-weight-normal ">{{ _('Clients') }}</h1>
                <p class="lead font-weight-normal">
                    {{ _('View and explore current clients.') }}</p>
                <a class="fas fa-gamepad btn-secondary btn-lg m-md-3"
                   title={{ _('Clients') }} href="{{ url_for('main.clients') }}"></a>
                <p>
                    <img src="{{ url_for('static', filename='clients.JPG') }}"
                     style="height: 400px;">
                </p>
            </div>
        </a>
    </div>
    </div>
    <a class="carousel-control-prev" href="#carousel"
             role="button" data-slide="prev">
            <i class="fas fa-arrow-alt-circle-left btn btn-dark btn-lg"></i>
            <span class="sr-only">Previous</span>
          </a>
    <a class="carousel-control-next" href="#carousel"
             role="button" data-slide="next">
            <i class="fas fa-arrow-alt-circle-right btn btn-dark btn-lg"></i>
            <span class="sr-only">Next</span>
    </a>
</div>
<script>
    function addNavLinks(procNav, pageNum, newText, hasAnother, followed){
        let navItem = '<li id="page'+ newText +'" class="page-item">' +
          '<a class="page-link" href="#" tabindex="-1" ' +
            'onclick="getProcessors(' + pageNum + ','+ followed+')"  >'+newText+'</a>' +
        '</li>';
        procNav.append(navItem);
        if (!(hasAnother)) {
           document.getElementById("page" + newText).classList.add("disabled");
        }
    }
    function getProcessors(pageNum, followed){
        let proc = $('#processors');
        let procNav = $('#processorsPage');
        proc.html('' +
            '<button class="btn btn-primary btn-block btn-lg" type="button" disabled>' +
              '<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>' +
              'Loading Live Processors...' +
            '</button>');
        procNav.html('');
        $.post('/get_live_processors',
            {
                page: pageNum,
                followed: followed
        }).done(function(data) {
            procNav.html('<ul id="processorsPage" class="pagination justify-content-center">\n' +
                '  </ul>');
            proc.html('<div id="processors" class="card-deck"></div>');
            for (let i = 0; i < data['items'].length; i++) {
                proc.append(data['items'][i])}
            addNavLinks(procNav, pageNum - 1, "Previous", data['has_prev'], followed);
            for (let i = 1; i < data['pages'] + 1; i++){
                procNav.append('<li id="page' + i + '" class="page-item"><a class="page-link" ' +
                    'onclick="getProcessors(' + i + ','+ followed+')" href=#>' + i + '</a></li>');
                if (pageNum === i) {
                    document.getElementById("page" + i).classList.add("active");
                }
            }
            addNavLinks(procNav, pageNum + 1, "Next", data['has_next'], followed);
            if (data['pages'] === 0) {
            proc.html('<h3 class="text-center">' +
                '{{ _('No processors you follow are live') }}' +
            '</h3><br>')
            }
        }).fail(function(jqXHR, textStatus ) {
            console.log("Request failed: " + textStatus);
            location.reload();
        }).always(function(){
        });
    }
    $(document).ready(function() {
       if (window.location.pathname === "/explore"){
           getProcessors(1, false);
       }
       else {
           getProcessors(1, true);
       }
    });
</script>
{% endblock %}