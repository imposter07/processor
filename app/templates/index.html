{% extends "base.html" %}

{% block app_header %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='liquid_table.css') }}">
    <h1 class="">{{ _('Hi, %(username)s!', username=current_user.username) }}</h1>
    <h6 class="card-subtitle mb-2 text-muted">
        Welcome to lqadata.com.  If you are new please check
        <a href="https://lqadata.com/help">help page</a> for more info!
        {% set count = namespace(value=0) %}
        {% for cur_tutorial in tutorials %}
            {% if cur_tutorial.tutorial_completed(current_user) %}
                {% set count.value = count.value + 1 %}
            {% endif %}
        {% endfor %}
        {% if tutorials %}
            You have completed <a href="{{ tutorials[0].get_tutorial_homepage_url() }}"><span class="font-weight-bold">{{ count.value }} tutorials.</span></a>
            {% if count.value == 2 %}
                <span class="text-success font-weight-bold">You are a true inspiration to us all!</span >
            {%  elif count.value == 1 %}
                <span class="text-warning font-weight-bold">It would be cooler if that number was 2.  But hey you tried!</span>
            {% else %}
                <span class="text-danger font-weight-bold">Unfortunately for you, however, you are trophyless.
                Without guidance, without the strength of tutorials...
                You are fated, it seems, to obscurity.</span>
            {% endif %}
        {% endif %}
    </h6>
{% endblock %}

{% block vertical_navbar %}
    <div class="card shadow outer">
        <div class="card-header">
            <h3>Latest Posts<i class="fas fa-comments btn btn-secondary"
                               style="float:right;"></i></h3>
            <h6 class="card-subtitle mb-2 text-muted">Posts from processors or
                users
                you follow that are mostly auto-generated. You can also post!</h6>
        </div>

        <div class="card-body">
            {% if form %}
                {% include '_form.html' %}
                <br>
            {% endif %}
            {% if not posts %}
                <h4 class="sidebar-heading d-flex justify-content-between align-items-center
           text-center">
                    <span>{{ _('No posts.  Follow something.') }}</span>
                </h4>
                <h4 class="sidebar-heading d-flex justify-content-between align-items-center
           text-center">
                    <a href="{{ url_for('main.clients') }}">{{ _('View clients') }}</a>
                    <a href="{{ url_for('main.processor') }}">{{ _('View processors') }}</a>
                </h4>
            {% endif %}
            {% for post in posts %}
                {% include '_post.html' %}
            {% endfor %}

            <nav aria-label="...">
                <ul class="pagination justify-content-center">
                    <li class="page-item{% if not prev_url %} page-item disabled{% endif %}">
                        <a class="page-link" href="{{ prev_url or '#' }}">
                            <span aria-hidden="true">&larr;</span> {{ _('Newer posts') }}
                        </a>
                    </li>
                    <li class="page-item{% if not next_url %} page-item disabled{% endif %}">
                        <a class="page-link" href="{{ next_url or '#' }}">
                            {{ _('Older posts') }} <span aria-hidden="true">&rarr;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
{% endblock %}

{% block app_content %}
<div class="card shadow outer">
    <div class="card-header">
        <h3>Live Processors<i class="fas fa-chart-bar btn btn-info"
                              style="float:right; opacity:.8;"></i></h3>
        <h6 class="card-subtitle mb-2 text-muted">Processor instances that
            are
            currently live. On your homepage you can follow more to have
            them appear here,
            or view the explore page to view all live processors.</h6>
    </div>
    <div class="card-body">
        <div id="processorSelectContainer"></div>
        <div id="processors" class="card-deck"></div>
        <br><br>
        <nav aria-label="Page navigation example">
            <ul id="processorsPage"
                class="pagination justify-content-center">
            </ul>
        </nav>
    </div>
</div>
<br>
<div class="row">
    <div class="col">
        <div class="card shadow outer">
            <div class="card-header">
                <h3>Open Requests<i class="fas fa-tasks btn btn-danger" style="float:right; opacity:.8;"></i></h3>
                <h6 class="card-subtitle mb-2 text-muted">Requests that have not been completed - generated automatically and by reporting QA.  Every instance would ideally have 0 open requests.</h6>
            </div>
            <div class="card-body">
                <div id="openRequests"></div>
            </div>
        </div>
    </div>
    {% include 'tutorials/tutorial_available.html' %}
</div>
<div class="row">
    <div class="col">
        <div class="card shadow outer">
            <div class="card-header">
                <h3>Notes<i class="fas fa-tasks btn btn-danger" style="float:right; opacity:.8;"></i></h3>
                <h6 class="card-subtitle mb-2 text-muted">Notes/POV from campaigns or meetings over the past week</h6>
            </div>
            <div class="card-body">
                <div id="notesTable"></div>
            </div>
        </div>
    </div>
</div>
<br><br>
<div id="carousel" class="carousel slide" data-ride="carousel">
    <div class="carousel-inner text-center">
        <div class="carousel-item active">
            <a class="entry-thumb" title={{ _('Processor') }}
                    href="{{ url_for('main.processor') }}"
               rel="noopener"
               target="_blank">
                <div class="position-relative overflow-hidden
                p-3 p-md-5 m-md-3 text-center">
                    <h1 class="display-4 font-weight-normal ">
                        {{ _('Processor') }}</h1>
                    <p class="lead font-weight-normal">
                        {{ _('Create, view and update live campaigns using the data processor.') }}</p>
                    <a class="fas fa-chart-bar btn-secondary btn-lg m-md-3"
                       title={{ _('Processor') }} href="{{ url_for('main.processor') }}"></a>
                    <p>
                        <img src="{{ url_for('static', filename='data.jpg') }}"
                             style="height: 400px;">
                    </p>
                </div>
            </a>
        </div>
        <div class="carousel-item">
            <a class="entry-thumb" title={{ _('Uploader') }}
                    href="{{ url_for('main.uploader') }}" rel="noopener"
               target="_blank">
                <div class="position-relative overflow-hidden
                p-3 p-md-5 m-md-3 text-center">
                    <h1 class="display-4 font-weight-normal ">
                        {{ _('Uploader') }}</h1>
                    <p class="lead font-weight-normal">
                        {{ _('Create and upload new campaigns to Facebook, AdWords and DCM.') }}</p>
                    <a class="fas fa-chart-bar btn-secondary btn-lg m-md-3"
                       title={{ _('Uploader') }} href="#"></a>
                    <p>
                        <img src="{{ url_for('static', filename='fb.jpg') }}"
                             style="height: 400px;">
                    </p>
                </div>
            </a>
        </div>
        <div class="carousel-item">
            <a class="entry-thumb" title={{ _('Clients') }}
                    href="{{ url_for('main.clients') }}" rel="noopener"
               target="_blank">
                <div class="position-relative overflow-hidden p-3 p-md-5 m-md-3 text-center">
                    <h1 class="display-4 font-weight-normal ">{{ _('Clients') }}</h1>
                    <p class="lead font-weight-normal">
                        {{ _('View and explore current clients.') }}</p>
                    <a class="fas fa-gamepad btn-secondary btn-lg m-md-3"
                       title={{ _('Clients') }} href="{{ url_for('main.clients') }}"></a>
                    <p>
                        <img src="{{ url_for('static', filename='clients.JPG') }}"
                             style="height: 400px;">
                    </p>
                </div>
            </a>
        </div>
    </div>
    <a class="carousel-control-prev" href="#carousel"
       role="button" data-slide="prev">
        <i class="fas fa-arrow-alt-circle-left btn btn-dark btn-lg"></i>
        <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#carousel"
       role="button" data-slide="next">
        <i class="fas fa-arrow-alt-circle-right btn btn-dark btn-lg"></i>
        <span class="sr-only">Next</span>
    </a>
</div>
<script src="{{ url_for('static', filename='js_utils.js') }}"></script>
<script src="{{ url_for('static', filename='liquid_table.js') }}"></script>
<script src="{{ url_for('static', filename='get_table.js') }}"></script>
<script>
    function addNavLinks(procNav, pageNum, newText, hasAnother, followed){
        let navItem = '<li id="page'+ newText +'" class="page-item">' +
          '<a class="page-link" href="#" tabindex="-1" ' +
            'onclick="getProcessors(' + pageNum + ','+ followed+')"  >'+newText+'</a>' +
        '</li>';
        procNav.append(navItem);
        if (!(hasAnother)) {
           document.getElementById("page" + newText).classList.add("disabled");
        }
    }
    function addProcessorsToSelect(data){
        let processorsSelectId = 'processorsSelect';
        let baseSelectBox =
            '<div class="input-group">' +
            '<select id=' + processorsSelectId + ' multiple=""' +
            'class="form-control form-control-sm">' +
            '<option value="">Select Live Processors...</option></select>' +
            '<div class="input-group-btn">' +
            '<button id="processorFilterSave"' +
            'class="btn btn-outline-success" type="button">Filter</button></div>'
            '</div>';
        let baseSelect = $('#processorSelectContainer');
        baseSelect.empty();
        baseSelect.append(baseSelectBox);
        let selectBox = document.getElementById(processorsSelectId);
        data.forEach(function (d) {
            selectBox.add(new Option(d));
        });
        addSelectize();
        projectNumberSelectChange();
    }
    function getProcessors(pageNum, followed, filterDict=null){
        let proc = $('#processors');
        let procNav = $('#processorsPage');
        proc.html('' +
            '<button class="btn btn-primary btn-block btn-lg" id="loadingBtn" type="button" disabled>' +
              '<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>' +
              'Loading Live Processors...' +
            '</button>');
        procNav.html('');
        $.post('/get_live_processors',
            {
                page: pageNum,
                followed: followed,
                filter_dict: JSON.stringify(filterDict)
        }).done(function(data) {
            addProcessorsToSelect(data['processors']);
            procNav.html('<ul id="processorsPage" class="pagination justify-content-center">\n' +
                '  </ul>');
            for (let i = 0; i < data['items'].length; i++) {
                proc.append(data['items'][i])}
            addNavLinks(procNav, pageNum - 1, "Previous", data['has_prev'], followed);
            for (let i = 1; i < data['pages'] + 1; i++){
                procNav.append('<li id="page' + i + '" class="page-item"><a class="page-link" ' +
                    'onclick="getProcessors(' + i + ','+ followed+')" href=#>' + i + '</a></li>');
                if (pageNum === i) {
                    document.getElementById("page" + i).classList.add("active");
                }
            }
            addNavLinks(procNav, pageNum + 1, "Next", data['has_next'], followed);
            if (data['pages'] === 0) {
            proc.html('<h3 class="text-center">' +
                '{{ _('No processors you follow are live') }}' +
            '</h3><br>')
            }
            addSelectize();
            getSelectedDashboard()
        }).fail(function(jqXHR, textStatus ) {
            console.log("Request failed: " + textStatus);
            location.reload();
        }).always(function(){
            $('#loadingBtn').remove();
        });
    }
    function projectNumberSelectChange() {
        $('[id^=processorFilterSave]').click(function () {
            let dropdownButton = "#" + $(this)[0].id;
            $(dropdownButton).prop("disabled", true);
            let oldHtml = $(dropdownButton).html();
            $(dropdownButton).html(
                `<span class="spinner-grow spinner-grow-sm" role="status"
                  aria-hidden="true"></span> Loading...`
            );
            let filterDict = [{'live': true}];
            filterDict = getFilters('processors', filterDict);
            getProcessorBasedOnPage(filterDict)
        })
    }
    function getOpenRequests(pageNum, followed, filterDict=null){
        let proc = $('#openRequests');
        proc.html('' +
            '<button class="btn btn-primary btn-block btn-lg" id="loadingBtn" type="button" disabled>' +
              '<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>' +
              'Loading Open Requests...' +
            '</button>');

        $.post('/get_open_processor_requests',
            {
                page: pageNum,
                followed: followed,
                filter_dict: JSON.stringify(filterDict)
        }).done(function(data) {
            proc.html(data['items'])
        }).fail(function(jqXHR, textStatus ) {
            console.log("Request failed: " + textStatus);
        }).always(function(){

        });
    }

    function getNotes() {
        getTable('notesTable', 'notesTable', '');
    }

    function getSelectedDashboard() {
        $('[id^=dashSelect]').unbind().on('change', function (e) {
            let selectedText = this.options[e.target.selectedIndex].text
            let procName = this.id.replace('dashSelect', '')
            $('#dashFooter' + procName).removeAttr('style')
            let metrics = ['kpi']
            let filterDict = {}
            let chartFunction = (function () {
                if (selectedText === 'Date') {
                    return generateAreaChart;
                } else {
                    return generateBarChart;
                }
            })
            getMetrics('#dash_placeholderMetrics' + procName, chartFunction(),
                selectedText, metrics,
                filterDict, "", 250, null, null, null, null, null, procName);
        });
    }
    function getProcessorBasedOnPage(filterDict=null) {
        if (window.location.pathname === "/explore"){
           getProcessors(1, false, filterDict);
           getOpenRequests(1, false, filterDict);
           getNotes();
       }
       else {
           getProcessors(1, true, filterDict);
           getOpenRequests(1, true, filterDict);
           getNotes();
       }
    }
    function loadJS(){
        getProcessorBasedOnPage();
    }
    $(document).ready(function() {
        loadJS();
    });
</script>
{% include "_select_builder.html" %}
{% include "_dash_builder.html" %}
{% endblock %}