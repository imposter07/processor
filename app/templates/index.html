{% extends "base.html" %}

{% block app_header %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='liquid_table.css') }}">
    <h1 class="">{{ _('Hi, %(username)s!', username=current_user.username) }}</h1>
    <h6 class="card-subtitle mb-2 text-muted">
        Welcome to lqadata.com.  If you are new please check
        <a href="https://lqadata.com/help">help page</a> for more info!
        {% set count = namespace(value=0) %}
        {% for cur_tutorial in tutorials %}
            {% if cur_tutorial.tutorial_completed(current_user) %}
                {% set count.value = count.value + 1 %}
            {% endif %}
        {% endfor %}
        {% if tutorials %}
            You have completed <a href="{{ tutorials[0].get_tutorial_homepage_url() }}"><span class="font-weight-bold">{{ count.value }} tutorials.</span></a>
            {% if count.value > 1 %}
                <span class="text-success font-weight-bold">You are a true inspiration to us all!</span >
            {%  elif count.value == 1 %}
                <span class="text-warning font-weight-bold">It would be cooler if that number was 2.  But hey you tried!</span>
            {% else %}
                <span class="text-danger font-weight-bold">Unfortunately for you, however, you are trophyless.
                Without guidance, without the strength of tutorials...
                You are fated, it seems, to obscurity.</span>
            {% endif %}
        {% endif %}
    </h6>
{% endblock %}

{% block vertical_navbar %}
    <div class="card shadow outer">
        <div class="card-header">
            <h3>Latest Posts<i class="bi bi-chat btn btn-secondary"
                               style="float:right;"></i></h3>
            <h6 class="card-subtitle mb-2 text-muted">Posts from processors or
                users
                you follow that are mostly auto-generated. You can also post!</h6>
        </div>

        <div class="card-body">
            {% if form %}
                {% include '_form.html' %}
                <br>
            {% endif %}
            {% if not posts %}
                <h4 class="sidebar-heading d-flex justify-content-between align-items-center
           text-center">
                    <span>{{ _('No posts.  Follow something.') }}</span>
                </h4>
                <h4 class="sidebar-heading d-flex justify-content-between align-items-center
           text-center">
                    <a href="{{ url_for('main.clients') }}">{{ _('View clients') }}</a>
                    <a href="{{ url_for('main.processor') }}">{{ _('View processors') }}</a>
                </h4>
            {% endif %}
            {% for post in posts %}
                {% include '_post.html' %}
            {% endfor %}

            <nav aria-label="...">
                <ul class="pagination justify-content-center">
                    <li class="page-item{% if not prev_url %} page-item disabled{% endif %}">
                        <a class="page-link" href="{{ prev_url or '#' }}">
                            <span aria-hidden="true">&larr;</span> {{ _('Newer posts') }}
                        </a>
                    </li>
                    <li class="page-item{% if not next_url %} page-item disabled{% endif %}">
                        <a class="page-link" href="{{ next_url or '#' }}">
                            {{ _('Older posts') }} <span aria-hidden="true">&rarr;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
{% endblock %}

{% block app_content %}
<div class="card shadow outer">
    <div class="card-header">
        <h3>Live Processors<i class="bi bi-bar-chart btn btn-info"
                              style="float:right; opacity:.8;"></i></h3>
        <h6 class="card-subtitle mb-2 text-muted">Processor instances that
            are
            currently live. On your homepage you can follow more to have
            them appear here,
            or view the explore page to view all live processors.</h6>
    </div>
    <div class="card-body">
        <div id="processorSelectContainer"></div>
        <div id="processors" class="card-group"></div>
        <br><br>
        <nav aria-label="Page navigation example">
            <ul id="processorsPage"
                class="pagination justify-content-center">
            </ul>
        </nav>
    </div>
</div>
<br>
<div class="row">
    <div class="col">
        <div class="card shadow outer">
            <div class="card-header">
                <h3>Open Requests<i class="bi bi-list-task btn btn-danger" style="float:right; opacity:.8;"></i></h3>
                <h6 class="card-subtitle mb-2 text-muted">Requests that have not been completed - generated automatically and by reporting QA.  Every instance would ideally have 0 open requests.</h6>
            </div>
            <div class="card-body">
                <div id="openRequests"></div>
            </div>
        </div>
    </div>
    {% include 'tutorials/tutorial_available.html' %}
</div>
<br>
<div class="row">
    <div class="col">
        <div class="card shadow outer">
            <div class="card-header">
                <h3>Notes<i class="bi bi-list-task btn btn-success" style="float:right; opacity:.8;"></i></h3>
                <h6 class="card-subtitle mb-2 text-muted">Notes/POV from campaigns or meetings over the past week</h6>
            </div>
            <div class="card-body d-grid gap-2">
                <button class="btn btn-primary btn-lg" id="notesTable"
                        type="button">
                    Get Notes
                </button>
            </div>
        </div>
    </div>
</div>
<br>
<div class="card shadow outer">
    <div class="card-header">
        <h3>Sandbox<i class="bi bi-hourglass btn btn-info"
                              style="float:right; opacity:.8;"></i></h3>
        <h6 class="card-subtitle mb-2 text-muted">
            Tests instances of a Processor/Plan and Uploader built specially for you, {{ user.username }}!
            Can complete challenges to learn here, or try things out without worrying about messing something up.
        </h6>
    </div>
    <div class="card-body">
        <div id="sandboxSelectContainer"></div>
        <div id="sandbox" class="card-group"></div>
        <br><br>
        <nav aria-label="Page navigation example">
            <ul id="sandboxPage"
                class="pagination justify-content-center">
            </ul>
        </nav>
    </div>
</div>
<br><br>

<script src="{{ url_for('static', filename='js_utils.js') }}"></script>
<script src="{{ url_for('static', filename='liquid_table.js') }}"></script>
<script src="{{ url_for('static', filename='get_table.js') }}"></script>
<script>
    function addNavLinks(procNav, pageNum, newText, hasAnother, followed) {
        let navItem = `
            <li id="page${newText}" class="page-item">
                <a class="page-link" href="#" tabindex="-1"
                onclick="getProcessors(${pageNum},${followed})">${newText}</a>
            </li>`;
        procNav.insertAdjacentHTML('beforeend', navItem);
        if (!(hasAnother)) {
           document.getElementById("page" + newText).classList.add("disabled");
        }
    }

    function addProcessorsToSelect(data){
        let processorsSelectId = 'processorsSelect';
        let baseSelectBox = `
            <div class="input-group">
                <select id=${processorsSelectId} multiple="" class="form-control">
                    <option value="">Select Live Processors...</option>
                </select>
                <button id="processorFilterSave" class="btn btn-outline-success"
                        type="button">Filter
                </button>
            </div>`;
        let baseSelect = document.getElementById('processorSelectContainer');
        baseSelect.innerHTML = baseSelectBox;
        let selectBox = document.getElementById(processorsSelectId);
        data.forEach(function (d) {
            selectBox.add(new Option(d));
        });
        addSelectize();
        addOnClickEvent('[id^=processorFilterSave]', projectNumberSelectChange);
    }

    function getProcessorsResponse(data, kwargs) {
        console.log(data)
        let pageNum = kwargs['pageNum'];
        let proc = kwargs['proc'];
        let procNav = kwargs['procNav'];
        let followed = kwargs['followed'];
        let pages = data['pages'];
        let originalElemId = kwargs['elemId'];
        addProcessorsToSelect(data['processors']);
        procNav.innerHTML = `
            <ul id="${originalElemId}Page" class="pagination justify-content-center">\n</ul>
        `;
        proc.innerHTML = '';
        data['items'].forEach(item => {
            proc.insertAdjacentHTML('beforeend', item);
        });
        addNavLinks(procNav, pageNum - 1, "Previous", data['has_prev'], followed);
        for (let i = 1; i < pages + 1; i++) {
            let idxFollowStr = `${i}, ${followed}`;
            let elemToAdd = `
                <li id="page${i}" class="page-item">
                    <a class="page-link" onclick="getProcessors(${idxFollowStr})" href=#>${i}
                    </a>
                </li>`;
            procNav.insertAdjacentHTML('beforeend', elemToAdd);
            if (pageNum === i) {
                document.getElementById("page" + i).classList.add("active");
            }
        }
        addNavLinks(procNav, pageNum + 1, "Next", data['has_next'], followed);
        if (pages === 0) {
            let elemToAdd = `
                <h3 class="text-center">
                    'No processors you follow are live'
                </h3><br>
            `
            proc.insertAdjacentHTML('beforeend', elemToAdd);
        }
        addSelectize();
        addOnClickEvent('[id^=dashSelect]', getSelectedDashboard, 'change');
        addElemRemoveLoadingBtn(originalElemId);
        addOnClickEvent('button[id*="createPlan"]', addCreatePlanEvent);
    }

    function getProcessors(pageNum, followed, filterDict=null, elemId='processors') {
        let proc = document.getElementById(elemId);
        let procNav = document.getElementById(`${elemId}Page`);
        loadingBtn(proc);
        let data = {
            page: pageNum,
            followed: followed,
            filter_dict: JSON.stringify(filterDict),
            elem_id: elemId
        }
        let kwargs = {
            'pageNum': pageNum,
            'procNav': procNav,
            'proc': proc,
            'followed': followed,
            'elemId': elemId
        }
        makeRequest(`get_live_processors`, 'POST', data, getProcessorsResponse,
            'json', kwargs);
    }

    function projectNumberSelectChange() {
        loadingBtn(this);
        let filterDict = [{'live': true}];
        filterDict = getFilters('#processors', filterDict);
        getProcessorBasedOnPage(filterDict);
    }

    function getOpenRequestsResponse(data, kwargs) {
        let openElem = kwargs['elem'];
        openElem.innerHTML = '';
        openElem.insertAdjacentHTML('beforeend', data['items']);
        addElemRemoveLoadingBtn(openElem.id);
    }

    function getOpenRequests(pageNum, followed, filterDict=null) {
        let openElem = document.getElementById('openRequests');
        loadingBtn(openElem);
        let data = {
            page: pageNum,
            followed: followed,
            filter_dict: JSON.stringify(filterDict)
        }
        let kwargs = {'elem': openElem}
        makeRequest('/get_open_processor_requests', 'POST', data,
            getOpenRequestsResponse, 'json', kwargs);
    }

    function getNotes() {
        let notesTableId = 'notesTable';
        document.getElementById(notesTableId).outerHTML = `<div id=${notesTableId}></div`;
        getTable(notesTableId, notesTableId);
    }

    function getSelectedDashboard(e) {
        let selectedText = e.target.options[e.target.selectedIndex].text;
        let procName = e.target.id.replace('dashSelect', '');
        let dashName = 'dash_placeholderMetrics' + procName;
        document.getElementById('dashFooter' + procName).removeAttribute('style');
        let metrics = ['kpi'];
        let filterDict = {};
        let chartFunction = (selectedText === 'Date') ?  'generateAreaChart' :
            'generateBarChart';
        let dash_metric_args = getDataTableArgsDict(chartFunction, [selectedText],
            metrics, filterDict, true, procName);
        getTable(dashName, dashName + 'Progress', 'None', 'None', 'None', true,
            'None', false, dash_metric_args);
    }

    function getProcessorBasedOnPage(filterDict=null) {
        if (window.location.pathname === "/explore"){
           getProcessors(1, false, filterDict);
           getOpenRequests(1, false, filterDict);
       }
       else {
           getProcessors(1, true, filterDict);
           getOpenRequests(1, true, filterDict);
           getProcessors(1, true, filterDict, 'sandbox');
       }
        addOnClickEvent('#notesTable', getNotes);
    }

    document.addEventListener("DOMContentLoaded", function() {
         getProcessorBasedOnPage();
    });
</script>
{% include "_select_builder.html" %}
{% include "dashboards/_dash_builder.html" %}
{% endblock %}