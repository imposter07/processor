{% extends "create_processor.html" %}
{% block app_content_2 %}
    <div id="{{ edit_name }}"></div>
    {% if brandtrackers is defined %}
        <div id="currentBrandtracker" data-btid="">
            <div id="brandtrackerTables"></div>
            <div id="brandtrackerTablesProgress"></div>
            <div id="brandtrackerForms">
                <div id="InfluenceForms" class="dimension-form" hidden>
                    {{ InfluenceForm|safe }}
                </div>
                <div id="EngagementForms" class="dimension-form" hidden>
                    {{ EngagementForm|safe }}
                </div>
                <div id="MomentumForms" class="dimension-form" hidden>
                    {{ MomentumForm|safe }}
                </div>

            </div>
        </div>
    {% endif %}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let tableName = document.getElementById('jinjaValues').dataset['edit_name'];
            let routeNames = ['Topline', 'PlanRules', 'PlanPlacements', 'RFP',
                'Specs', 'Contacts', 'Calc', 'Checklist'];
            if (routeNames.includes(tableName)) {
                getTable(tableName, tableName);
            }
        });
        function getBrandtrackerFormData() {
            let formIds = ['base_form_id', 'InfluenceForm', 'EngagementForm',
                'MomentumForm'];
            let validForms = validateFormsById(formIds);
            if (!validForms) {
                displayAlert('Invalid Input. Please adjust and try again',
                    'warning');
                return
            }
            return prepareFormsForRequest(formIds);
        }

        function saveBrandtracker() {
            let data = getBrandtrackerFormData();
            let jv = document.getElementById('jinjaValues');
            data['object_name'] = jv.dataset['object_name'].trim();
            makeRequest('/save_brandtracker', 'POST', data,
                saveBrandtrackerModalResponse);
        }

        function saveBrandtrackerModalResponse(response) {
            displayAlert(response['message'], response['level']);
        }

        function addComponentOnClick() {
            let form = this.closest('form');
            let formData = new FormData(form);
            makeRequest('/add_brandtracker_component',
                'POST', formData, addDeleteComponentResponse);
        }

        function addDeleteComponentResponse(data) {
            let formId = data['form_id'];
            document.getElementById(formId).innerHTML = data['form'];
            brandTrackerListeners(false);
        }

        function deleteComponentOnClick(event) {
            let form = this.closest('form');
            let formData = new FormData(form);
            let delete_id = event.currentTarget.id;
            let url = '/delete_brandtracker_component?delete_id='.concat(delete_id);
            makeRequest(url, 'POST', formData, addDeleteComponentResponse);
        }

        function getDimension() {
            let dimSelect = document.querySelector('select#categories');
            let dimension = dimSelect.selectize.getValue();
            let formId = `${dimension}Forms`;
            let forms = document.querySelectorAll('.dimension-form');
            forms.forEach(form => {
                if (form.id == formId) {
                    form.removeAttribute('hidden');
                } else {
                    form.setAttribute('hidden', '');
                }
            })
        }

        function updateBtTables() {
            let data = getBrandtrackerFormData();
            getTable('brandtrackerTables', 'brandtrackerTables', 'None',
                'None', 'None', true, 'None', false, data)
        }

        function brandTrackerListeners(get=true) {
            addSelectize();
            addOnClickEvent('select#categories', getDimension, 'change');
            addOnClickEvent('input[id*="add_child"][value="Add Data Point"]',
                addComponentOnClick);
            addOnClickEvent('input[id^="components-"][id$="-delete"][value="Delete"]',
                deleteComponentOnClick);
            addOnClickEvent('input[id="update_data"]',
                () => {updateBtTables()});
            if (get) {
                updateBtTables();
            }
        }
    </script>
{% endblock %}
