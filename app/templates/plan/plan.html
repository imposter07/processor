{% extends "create_processor.html" %}
{% block app_content_2 %}
    <style>
        .hiddenRow {
            padding: 0 !important;
        }
    </style>
    {% if edit_name == 'Topline' %}
        <div class="card-deck container-fluid text-center">
            <div id="totalCards" class="row w-100"></div>
        </div>
        <button id="addPartner"
                class="btn btn-outline-success btn-block text-left"
                type="button" href="">
            <i class="fas fa-plus"
               role="button"></i>
            {{ _('Add Partner') }}
        </button><br>
        <table id="planTable" class="table table-striped table-responsive-sm small">
            <thead>
            <tr>
                {% for table_head in topline_headers %}
                    <th id="col{{ table_head }}">{{ table_head }}</th>
                {% endfor %}
            </tr>
            </thead>
            <tbody id="accordionPlan">

            </tbody>
        </table>
    {% endif %}
    <script>
        function shadeDates(loopIndex) {
            const fp = document.querySelector('#datePicker' + loopIndex)._flatpickr;
            let dateRange = fp.selectedDates;
            let startDate = new Date(dateRange[0]);
            let endDate = new Date(dateRange[1]);
            let calStart = '';
            let calEnd = '';
            let element = '';
            let elementId = '';
            {% for week in weeks %}
                calStart = new Date("{{ week[0] }}");
                calEnd = new Date("{{ week[1] }}");
                elementId = "row" + "{{ week[0] }}" + loopIndex;
                if (calEnd >= startDate && calStart <= endDate) {
                    element = document.getElementById(elementId);
                    element.style.backgroundColor = "#b3ecff";
                }
            {% endfor %}
        }
        function addPartner(clickElem, oldHtml, partner = null) {
            let d1 = document.getElementById('accordionPlan');
            let loopIndex = d1.querySelectorAll(".accordion:last-child");
            loopIndex = (loopIndex.length != 0) ? (parseInt(loopIndex[loopIndex.length- 1].id.replace('accordionPartner', '')) + 1).toString() : '0'
            let tableHeaders = ''
            {% for table_head in topline_headers %}
                tableHeaders = tableHeaders + '<td id="row' + "{{table_head}}" + loopIndex + '"></td>'
            {% endfor %}
            let partnerCard = `
                <tr data-toggle="collapse" data-target="#collapsePartner` + loopIndex + `" class="accordion-toggle">
                    ` + tableHeaders + `
                </tr>
                <tr>
                    <td colspan="12" class="hiddenRow">
                    <div id="collapsePartner` + loopIndex + `" class="collapse"
                         aria-labelledby="heading` + loopIndex + `"
                         data-parent="#accordionPlan">
                        <div class="card-body">
                            <div class="accordion" id="accordionPartner` + loopIndex + `" >
                                <form id="toplinePartner` + loopIndex + `"  class="row">
                                    <div class="col form-group">
                                        <label class="control-label" for="partnerSelect` + loopIndex + `">Partner</label>
                                        <select id="partnerSelect` + loopIndex + `"
                                                class="form-control form-control-sm"
                                                name="name` + loopIndex + `">
                                            <option value="">Partner Name</option>
                                        </select>
                                    </div>
                                    <div class="col form-group">
                                        <label class="control-label" for="datePicker` + loopIndex + `">Dates</label>
                                        <input id="datePicker` + loopIndex + `"
                                               class="custom-select custom-select-sm
                                                                      flatpickr flatpickr-input active"
                                               type="text" placeholder="Date"
                                               data-id="range" name="dates` + loopIndex + `"
                                               readonly="readonly" data-input>
                                    </div>
                                    <div class="col form-group">
                                      <label class="control-label" for="total_budget` + loopIndex + `">Total Budget</label>
                                      <input class="form-control form-control-sm" id="total_budget` + loopIndex + `" name="total_budget` + loopIndex + `" step="any" type="number" value="">
                                    </div>
                                    <div class="col form-group">
                                      <label class="control-label" for="estimated_cpm` + loopIndex + `">CPM</label>
                                      <input class="form-control form-control-sm" id="estimated_cpm` + loopIndex + `" name="estimated_cpm` + loopIndex + `" step="any" type="number" value="">
                                    </div>
                                    <div class="col form-group">
                                      <label class="control-label" for="estimated_cpc` + loopIndex + `">CPC</label>
                                      <input class="form-control form-control-sm" id="estimated_cpc` + loopIndex + `" name="estimated_cpc` + loopIndex + `" step="any" type="number" value="">
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    </td>
                </tr>`;
            d1.insertAdjacentHTML('beforeend', partnerCard);
            $(clickElem).prop("disabled", false);
            $(clickElem).html(oldHtml);
            addSelectize()
            addDatePicker()
            if (partner) {
                let selectize = $('#partnerSelect' + loopIndex)[0].selectize;
                selectize.addOption({text: partner.name, id: partner.name, value: partner.name});
                selectize.setValue(partner.name);
                let fp = document.getElementById("datePicker" + loopIndex)._flatpickr;
                fp.setDate([partner.start_date, partner.end_date])
                document.getElementById("total_budget" + loopIndex).value = partner.total_budget;
                document.getElementById("estimated_cpm" + loopIndex).value = partner.estimated_cpm;
                document.getElementById("estimated_cpc" + loopIndex).value = partner.estimated_cpc;
                document.getElementById('rowPartner' + loopIndex).innerHTML = partner.name;
                document.getElementById('rowCost' + loopIndex).innerHTML = "$" + partner.total_budget;
                document.getElementById('roweCPM' + loopIndex).innerHTML = "$" + partner.estimated_cpm;
                document.getElementById('roweCPC' + loopIndex).innerHTML = "$" + partner.estimated_cpc;
                shadeDates(loopIndex);
            }
        }

        function addPartnerOnClick() {
            $('[id^=addPartner]').unbind().click(function () {
                let clickElem = "#" + $(this)[0].id;
                $(clickElem).prop("disabled", true);
                let oldHtml = $(clickElem).html();
                $(clickElem).html(
                    `<span class="spinner-grow spinner-grow-sm" role="status"
                  aria-hidden="true"></span> Loading...`
                );

                addPartner(clickElem, oldHtml);
            })
        }

        function addDatePicker() {
            $('[id^=datePicker]').flatpickr({
                mode: "range",
            });
        }

        function submitToplineForm(formContinue) {
            let formTopline = $('[id^=toplinePartner]').serializeArray()
            saveToplinePartners(formTopline, formContinue)
        }

        function saveToplinePartners(formTopline, formContinue) {
            $.ajax({
                type: "POST",
                url: "/save_topline",
                data: {
                    object_name: "{{ object_name }}",
                    object_type: "{{ title }}",
                    object_level: "{{ edit_name }}",
                    placement_form: formTopline
                },
            }).done(function (data, status) {
                displayAlert(data['message'], data['level'])
                if (data['level'] === 'success') {
                    let element = document.getElementsByClassName('jumbotron')[0];
                    let originalColor = element.style.backgroundColor;
                    element.style.backgroundColor = "#b3ecff";
                    let t = setTimeout(function () {
                        element.style.backgroundColor = originalColor;
                    }, (2 * 1000));
                if (formContinue) {
                    let nextPage = window.location.href.replace(
                        '#', '').replace('clean', 'export')
                    window.location.href = nextPage
                    }
                }

            }).fail(function (jqXHR, textStatus) {

            }).always(function () {
                $('#loadingBtn').remove()
                $('#loadRefresh').show()
                unanimateBar()
            });
        }

        function addCurrentPartners(){
            let cpart = {};
            {% for partner in partners %}
                cpart = {
                    name:"{{ partner.name }}",
                    start_date: "{{ partner.start_date}}",
                    end_date: "{{ partner.end_date}}",
                    total_budget: {{ partner.total_budget }},
                    estimated_cpm: {{ partner.estimated_cpm }},
                    estimated_cpc: {{ partner.estimated_cpc }}
                };
                addPartner('', '', cpart);
            {% endfor %}
        }

        $('.collapse').on('show.bs.collapse', function () {
            $('.collapse.in').collapse('hide');
        });

        function getAllElementsWithAttribute(attribute) {
            var matchingElements = [];
            var allElements = document.querySelectorAll("#planTable > thead > tr > th");
            for (var i = 0, n = allElements.length; i < n; i++) {
                if (allElements[i].getAttribute(attribute) !== null) {
                    // Element exists with attribute. Add to array.
                    matchingElements.push(allElements[i]);
                }
            }
            return matchingElements;
        }

        function populateTotalCards() {
            let table = document.getElementById("accordionPlan");
            let sumCost = 0;
            let sumImps = 0;
            let sumClicks = 0;
            for (let i = 0; i < (table.rows.length - 1); i += 2) {
                let cost = parseFloat(table.rows[i].cells[1].innerHTML.replace('$', ''));
                sumCost = sumCost + cost;
                let partnerNum = i / 2;
                let cpm = parseFloat(document.getElementById('roweCPM' + partnerNum).innerHTML.replace('$', ''));
                let imps = (cost / cpm) * 1000;
                sumImps = sumImps + imps;
                let cpc = parseFloat(document.getElementById('roweCPC' + partnerNum).innerHTML.replace('$', ''));
                let clicks = (cost / cpc);
                sumClicks = sumClicks + clicks;
            }
            let percentTotal = sumCost / parseFloat("{{ object.total_budget }}");
            let formatter = new Intl.NumberFormat('en-US', {
              style: 'currency',
              currency: 'USD',
              // These options are needed to round to whole numbers if that's what you want.
              //minimumFractionDigits: 0, // (this suffices for whole numbers, but will print 2500.10 as $2,500.1)
              //maximumFractionDigits: 0, // (causes 2500.99 to be printed as $2,501)
            });
            let data = [
                {name:"Net Cost", current_value:formatter.format(sumCost), msg:"Of Total Budget", change: percentTotal},
                {name:"Impressions", current_value:sumImps.toLocaleString("en-US"), msg:"", change: ""},
                {name:"Clicks", current_value:sumClicks.toLocaleString("en-US"), msg:"", change: ""},
                {name:"CPM", current_value:formatter.format(sumCost / (sumImps / 1000)), msg:"", change: ""},
                {name:"CPC", current_value:formatter.format(sumCost / sumClicks), msg:"", change: ""},]
            generateTotalCards('#totalCards', data);
        }

        $(document).ready(function () {
            addPartnerOnClick();
            addCurrentPartners();
            addSelectize();
            addDatePicker();
            populateTotalCards();
        });

    </script>
{% endblock %}
